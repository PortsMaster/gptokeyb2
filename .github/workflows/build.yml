name: gptokeyb2 Build

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths-ignore:
      - '**/README.md'
  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - '**/README.md'

jobs:
  # ----------------------------------------------------------------
  # JOB 1: Cross-Compilation for ARM (Debian Bullseye Container)
  # ----------------------------------------------------------------
  build-arm:
    runs-on: ubuntu-latest
    container:
      image: debian:bullseye
    name: Debian ${{ matrix.arch.name }}
    strategy:
      fail-fast: false
      matrix:
        arch: 
          - name: arm64
            cross: aarch64-linux-gnu
            executable: aarch64
          - name: armhf
            cross: arm-linux-gnueabihf
            executable: armhf

    steps:
      - name: Install ${{ matrix.arch.name }} dependencies
        run: |
          dpkg --add-architecture ${{ matrix.arch.name }}
          apt update
          apt install -y --no-install-recommends python3 git build-essential patchelf linux-libc-dev-${{ matrix.arch.name }}-cross gcc-${{ matrix.arch.cross }} libsdl2-dev:${{ matrix.arch.name }} libevdev-dev:${{ matrix.arch.name }} ca-certificates cmake ninja-build

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build ${{ matrix.arch.name }}
        run: |
          mkdir build && cd build
          # We explicitly define library paths to bypass search issues in the cross-compile toolchain
          cmake ../ -GNinja \
            -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchains/debian-${{ matrix.arch.name }}-gcc-toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DLIBEVDEV_LIBRARY="/usr/lib/${{ matrix.arch.cross }}/libevdev.so" \
            -DLIBEVDEV_INCLUDE_DIR="/usr/include/libevdev-1.0" \
            -DSDL2_LIBRARY="/usr/lib/${{ matrix.arch.cross }}/libSDL2.so" \
            -DSDL2_INCLUDE_DIR="/usr/include/SDL2"
          cmake --build .
        
      - name: Prepare export
        run: |
          cd build
          patchelf --replace-needed libinterpose.so libinterpose.${{ matrix.arch.executable }}.so gptokeyb2
          patchelf --set-soname libinterpose.${{ matrix.arch.executable }}.so lib/libinterpose.so
          mv lib/libinterpose.so libinterpose.${{ matrix.arch.executable }}.so
          /usr/${{ matrix.arch.cross }}/bin/strip gptokeyb2
          mv gptokeyb2 gptokeyb2.${{ matrix.arch.executable }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gptokeyb2_${{ matrix.arch.name }}
          path: |
            ${{ github.workspace }}/build/*.${{ matrix.arch.executable }}*

  # ----------------------------------------------------------------
  # JOB 2: Native Build for x86_64 (Ubuntu 24.04)
  # ----------------------------------------------------------------
  build-native:
    runs-on: ubuntu-24.04
    name: Ubuntu x86_64
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y libsdl2-dev libevdev-dev cmake ninja-build patchelf build-essential git

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build x86_64
        run: |
          mkdir build && cd build
          # No toolchain file needed. 
          # We still hint the include dir because libevdev hides headers in a versioned subfolder.
          cmake ../ -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLIBEVDEV_INCLUDE_DIR="/usr/include/libevdev-1.0"
          cmake --build .

      - name: Prepare export
        run: |
          cd build
          # Rename libraries and patch dependency links
          patchelf --replace-needed libinterpose.so libinterpose.x86_64.so gptokeyb2
          patchelf --set-soname libinterpose.x86_64.so lib/libinterpose.so
          mv lib/libinterpose.so libinterpose.x86_64.so
          
          # Strip and rename executable
          strip gptokeyb2
          mv gptokeyb2 gptokeyb2.x86_64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gptokeyb2_x86_64
          path: |
            ${{ github.workspace }}/build/*.x86_64*
